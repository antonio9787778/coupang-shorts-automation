name: ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ìë™í™”

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  test-dummy:
    name: 1ë‹¨ê³„ - ë”ë¯¸ ë°ì´í„° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: ë”ë¯¸ ë°ì´í„° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: python test_coupang_logic.py

  coupang-api:
    name: 2ë‹¨ê³„ - ì¿ íŒ¡ API ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: test-dummy
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: requests ì„¤ì¹˜
        run: pip install requests
      
      - name: ì¿ íŒ¡ ì˜ˆìƒ ê³ ìˆ˜ìˆ˜ë£Œ ì œí’ˆ ì°¾ê¸°
        id: coupang_run
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
        run: |
          python coupang_smart_finder.py 2>&1 | tee result.txt
      
      - name: í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì „ì†¡
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          PREV_STATUS="${{ needs.test-dummy.result }}"
          
          if [ "$STATUS" = "success" ] && [ "$PREV_STATUS" = "success" ]; then
            EMOJI="âœ…"
            TITLE="ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ìë™í™” ì„±ê³µ!"
          else
            EMOJI="âŒ"
            TITLE="ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ìë™í™” ì‹¤íŒ¨"
          fi
          
          TIMESTAMP=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')
          
          # ê²°ê³¼ ìš”ì•½ ì¶”ì¶œ
          if [ -f result.txt ]; then
            TOTAL=$(grep "âœ… ì™„ë£Œ" result.txt | grep -oP '\d+(?=ê°œ)' | head -1)
            TOP_RATE=$(grep "ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨:" result.txt | head -1 | grep -oP '\d+\.\d+(?=%)')
            TOP_COMMISSION=$(grep "ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ:" result.txt | head -1 | grep -oP '\d+,?\d*(?=ì›)')
            TOP_NAME=$(grep "ğŸ¥‡ ìµœê³  ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨ ì œí’ˆ:" result.txt -A 1 | tail -1 | xargs)
            
            SUMMARY="ğŸ“Š ì´ ${TOTAL:-0}ê°œ ê³ ìˆ˜ìˆ˜ë£Œ ì œí’ˆ ë°œê²¬
ğŸ¥‡ ìµœê³  ìˆ˜ìˆ˜ë£Œìœ¨: ${TOP_RATE:-N/A}%
ğŸ’µ ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ: ${TOP_COMMISSION:-N/A}ì›"
          else
            SUMMARY="âŒ ì‹¤í–‰ ê²°ê³¼ ì—†ìŒ"
          fi
          
          MESSAGE="${EMOJI} *${TITLE}*

ğŸ“… ${TIMESTAMP}

${SUMMARY}

ğŸ”— [ìƒì„¸ ë¡œê·¸ ë³´ê¸°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true
