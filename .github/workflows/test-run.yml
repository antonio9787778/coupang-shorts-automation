name: ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ìë™í™”

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ KST

jobs:
  test-dummy:
    name: 1ë‹¨ê³„ - ê¸°ë³¸ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: python test_coupang_logic.py

  coupang-api:
    name: 2ë‹¨ê³„ - ì¿ íŒ¡ API ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: test-dummy
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: requests ì„¤ì¹˜
        run: pip install requests
      
      - name: ì¿ íŒ¡ ì œí’ˆ ì°¾ê¸°
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
        run: python coupang_smart_finder.py | tee result.txt
      
      - name: í…”ë ˆê·¸ë¨ ì „ì†¡
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸ“± í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹œì‘..."
          
          # 1ë‹¨ê³„: result.txt ì¡´ì¬ í™•ì¸
          if [ ! -f result.txt ]; then
            echo "âŒ result.txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            MESSAGE="âš ï¸ ì¿ íŒ¡ ê²€ìƒ‰ ì‹¤í–‰ ì™„ë£Œ\ní•˜ì§€ë§Œ result.txt ìƒì„± ì‹¤íŒ¨"
            curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}"
            exit 0
          fi
          
          echo "âœ… result.txt íŒŒì¼ ì¡´ì¬"
          echo "íŒŒì¼ í¬ê¸°: $(wc -l < result.txt) ì¤„"
          
          # 2ë‹¨ê³„: Python íŒŒì‹±
          cat << 'PYEND' > parse.py
import re
from datetime import datetime

try:
    with open('result.txt', 'r', encoding='utf-8') as f:
        content = f.read()
    
    print("íŒŒì¼ ì½ê¸° ì„±ê³µ")
    print(f"ë‚´ìš© ê¸¸ì´: {len(content)} ì")
    
    now = datetime.now().strftime('%Y-%m-%d %H:%M KST')
    
    # ì¹´í…Œê³ ë¦¬ë³„ ë¶„ë¦¬
    categories = re.split(r'={70}\nğŸ“Œ í‚¤ì›Œë“œ: ', content)
    print(f"ì¹´í…Œê³ ë¦¬ ê°œìˆ˜: {len(categories)}")
    
    result = f"ğŸ¯ *ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ê³ ìˆ˜ìˆ˜ë£Œ ì œí’ˆ*\nğŸ“… {now}\n\n"
    
    found_products = False
    
    for cat in categories[1:]:
        lines = cat.split('\n')
        keyword = lines[0].strip()
        
        result += f"ğŸ“‚ *{keyword}*\n\n"
        
        # ì œí’ˆ ì¶”ì¶œ (ê°„ë‹¨í•œ íŒ¨í„´)
        products = re.findall(
            r'(\d+)\. (.+?)\n'
            r'(?:\s+ğŸš€ ë¡œì¼“ë°°ì†¡\n)?'
            r'\s+ğŸ’° ê°€ê²©: ([\d,]+)ì›\n'
            r'\s+ğŸ“‚ ì¹´í…Œê³ ë¦¬: (.+?)\n'
            r'\s+ğŸ“Š ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨: ([\d.]+)%'
            r'.+?'
            r'\s+ğŸ’µ ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ: ([\d,]+)ì›\n'
            r'\s+â­ ìš°ì„ ìˆœìœ„ ì ìˆ˜: ([\d.]+)\n'
            r'\s+ğŸ”— (https?://[^\s]+)',
            cat, re.DOTALL
        )
        
        print(f"{keyword}: {len(products)}ê°œ ì œí’ˆ ë°œê²¬")
        
        if products:
            found_products = True
            # ë¡œì¼“ë°°ì†¡ ì²´í¬
            rocket_set = set(re.findall(r'(\d+)\. .+?\n\s+ğŸš€ ë¡œì¼“ë°°ì†¡', cat))
            
            for i, prod in enumerate(products[:3], 1):
                rank, name, price, category, rate, commission, score, url = prod
                name_short = name[:35] + '...' if len(name) > 35 else name
                rocket = "ğŸš€ " if rank in rocket_set else ""
                
                result += f"*{i}. {rocket}{name_short}*\n"
                result += f"ğŸ’° {price}ì› | ğŸ“Š {rate}%\n"
                result += f"ğŸ’µ {commission}ì› | â­ {score}ì \n"
                result += f"ğŸ”— {url}\n\n"
        else:
            result += "   âš ï¸ ì œí’ˆ ì—†ìŒ\n\n"
    
    # ìš”ì•½
    summary = re.search(r'ì´ (\d+)ê°œ ì˜ˆìƒ ê³ ìˆ˜ìˆ˜ë£Œ', content)
    best_rate = re.search(r'ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨: ([\d.]+)%', content)
    
    result += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    if summary:
        result += f"âœ… ì´ {summary.group(1)}ê°œ ì œí’ˆ ë°œê²¬\n"
    if best_rate:
        result += f"ğŸ¥‡ ìµœê³  ìˆ˜ìˆ˜ë£Œìœ¨: {best_rate.group(1)}%"
    
    if not found_products:
        result += "\nâš ï¸ ê²€ìƒ‰ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤"
    
    print("íŒŒì‹± ì™„ë£Œ!")
    print(result)
    
    with open('message.txt', 'w', encoding='utf-8') as f:
        f.write(result)
    
    print("message.txt ì €ì¥ ì™„ë£Œ")

except Exception as e:
    print(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
    import traceback
    traceback.print_exc()
    
    # ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ë©”ì‹œì§€
    with open('message.txt', 'w', encoding='utf-8') as f:
        f.write(f"âš ï¸ ì¿ íŒ¡ ê²€ìƒ‰ ì‹¤í–‰ ì™„ë£Œ\níŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
PYEND
          
          # 3ë‹¨ê³„: íŒŒì‹± ì‹¤í–‰
          python3 parse.py
          
          # 4ë‹¨ê³„: ë©”ì‹œì§€ íŒŒì¼ í™•ì¸
          if [ ! -f message.txt ]; then
            echo "âŒ message.txt ìƒì„± ì‹¤íŒ¨"
            MESSAGE="âš ï¸ ì¿ íŒ¡ ê²€ìƒ‰ ì™„ë£Œ, ë©”ì‹œì§€ ìƒì„± ì‹¤íŒ¨"
            curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}"
            exit 0
          fi
          
          echo "âœ… message.txt ìƒì„± ì„±ê³µ"
          echo "ë‚´ìš©:"
          cat message.txt
          echo ""
          
          # 5ë‹¨ê³„: í…”ë ˆê·¸ë¨ ì „ì†¡
          MESSAGE=$(cat message.txt)
          
          # íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
          MESSAGE_ESCAPED=$(echo "$MESSAGE" | jq -Rs .)
          
          # API í˜¸ì¶œ
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${TELEGRAM_CHAT_ID}\",\"text\":${MESSAGE_ESCAPED},\"parse_mode\":\"Markdown\"}")
          
          echo "í…”ë ˆê·¸ë¨ API ì‘ë‹µ:"
          echo "$RESPONSE"
          
          # ì„±ê³µ í™•ì¸
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… í…”ë ˆê·¸ë¨ ì „ì†¡ ì„±ê³µ!"
          else
            echo "âš ï¸ í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨ (í•˜ì§€ë§Œ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì†)"
          fi
