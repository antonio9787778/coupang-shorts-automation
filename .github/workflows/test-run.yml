name: ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ìë™í™”

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ KST

jobs:
  test-dummy:
    name: 1ë‹¨ê³„ - ê¸°ë³¸ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: python test_coupang_logic.py

  coupang-api:
    name: 2ë‹¨ê³„ - ì¿ íŒ¡ API ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: test-dummy
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: requests ì„¤ì¹˜
        run: pip install requests
      
      - name: ì¿ íŒ¡ ì œí’ˆ ì°¾ê¸°
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
        run: python coupang_smart_finder.py | tee result.txt
      
      - name: í…”ë ˆê·¸ë¨ ì „ì†¡
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          cat << 'SCRIPT' > parse.py
          import re, sys
          from datetime import datetime
          
          with open('result.txt', 'r', encoding='utf-8') as f:
              content = f.read()
          
          now = datetime.now().strftime('%Y-%m-%d %H:%M KST')
          categories = re.split(r'={70}\nğŸ“Œ í‚¤ì›Œë“œ: ', content)
          
          result = f"ğŸ¯ *ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ê³ ìˆ˜ìˆ˜ë£Œ ì œí’ˆ*\nğŸ“… {now}\n\n"
          
          for cat in categories[1:]:
              lines = cat.split('\n')
              keyword = lines[0].strip()
              result += f"ğŸ“‚ *{keyword}*\n\n"
              
              products = re.findall(
                  r'(\d+)\. (.+?)\n'
                  r'(?:\s+ğŸš€ ë¡œì¼“ë°°ì†¡\n)?'
                  r'\s+ğŸ’° ê°€ê²©: ([\d,]+)ì›\n'
                  r'\s+ğŸ“‚ ì¹´í…Œê³ ë¦¬: (.+?)\n'
                  r'\s+ğŸ“Š ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨: ([\d.]+)% \(ì¶”ì •ì¹˜\)\n'
                  r'\s+ğŸ’µ ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ: ([\d,]+)ì›\n'
                  r'\s+â­ ìš°ì„ ìˆœìœ„ ì ìˆ˜: ([\d.]+)\n'
                  r'\s+ğŸ”— (https?://[^\s]+)',
                  cat, re.DOTALL
              )
              
              rocket_set = set(re.findall(r'(\d+)\. .+?\n\s+ğŸš€ ë¡œì¼“ë°°ì†¡', cat))
              
              for i, prod in enumerate(products[:3], 1):
                  rank, name, price, category, rate, commission, score, url = prod
                  name_short = name[:40] + '...' if len(name) > 40 else name
                  rocket = "ğŸš€ " if rank in rocket_set else ""
                  
                  result += f"*{i}. {rocket}{name_short}*\n"
                  result += f"ğŸ’° {price}ì› | ğŸ“Š {rate}% | ğŸ’µ {commission}ì›\n"
                  result += f"â­ {score}ì \n"
                  result += f"ğŸ”— `{url}`\n\n"
              
              if not products:
                  result += "   âš ï¸ ì œí’ˆ ì—†ìŒ\n\n"
          
          summary = re.search(
              r'ì´ (\d+)ê°œ ì˜ˆìƒ ê³ ìˆ˜ìˆ˜ë£Œ.+?'
              r'ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨: ([\d.]+)%\n.+?'
              r'ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ: ([\d,]+)ì›\n.+?'
              r'ë¡œì¼“ë°°ì†¡: ([OX])\n.+?'
              r'ìš°ì„ ìˆœìœ„ ì ìˆ˜: ([\d.]+)',
              content, re.DOTALL
          )
          
          rocket_ratio = re.search(r'ë¡œì¼“ë°°ì†¡ ë¹„ìœ¨: ([\d.]+)%', content)
          
          result += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
          if summary:
              total, rate, commission, rocket, score = summary.groups()
              result += f"âœ… ì´ {total}ê°œ ì œí’ˆ ë°œê²¬\n"
              result += f"ğŸ¥‡ ìµœê³ : {rate}% ({commission}ì›)\n"
              result += f"â­ {score}ì  | ğŸš€ {rocket}\n"
              if rocket_ratio:
                  result += f"ğŸš€ ë¡œì¼“ë°°ì†¡: {rocket_ratio.group(1)}%"
          
          print(result)
          SCRIPT
          
          python3 parse.py > message.txt
          MESSAGE=$(cat message.txt)
          
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${TELEGRAM_CHAT_ID}\",\"text\":$(echo \"$MESSAGE\"|jq -Rs .),\"parse_mode\":\"Markdown\"}"
