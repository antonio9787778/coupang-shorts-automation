name: Ïø†Ìå° ÌååÌä∏ÎÑàÏä§ ÏûêÎèôÌôî

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  test-dummy:
    name: 1Îã®Í≥Ñ - ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÌÖåÏä§Ìä∏
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: ÎçîÎØ∏ ÌÖåÏä§Ìä∏
        run: python test_coupang_logic.py

  coupang-api:
    name: 2Îã®Í≥Ñ - Ïø†Ìå° API Ïã§Ìñâ
    runs-on: ubuntu-latest
    needs: test-dummy
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: requests ÏÑ§Ïπò
        run: pip install requests
      
      - name: Ïø†Ìå° Ï†úÌíà Ï∞æÍ∏∞
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
        run: python coupang_smart_finder.py > result.txt 2>&1
      
      - name: Í≤∞Í≥º Ï†ïÎ¶¨ Î∞è ÌÖîÎ†àÍ∑∏Îû® Ï†ÑÏÜ°
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          cat << 'PYTHON_SCRIPT' > parse_result.py
          import re
          import sys
          from datetime import datetime
          
          try:
              with open('result.txt', 'r', encoding='utf-8') as f:
                  content = f.read()
          except:
              print("ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®")
              sys.exit(1)
          
          # ÌòÑÏû¨ ÏãúÍ∞Ñ
          now = datetime.now().strftime('%Y-%m-%d %H:%M KST')
          
          # Ïπ¥ÌÖåÍ≥†Î¶¨Î≥ÑÎ°ú Î∂ÑÎ¶¨
          categories = re.split(r'={70}\nüìå ÌÇ§ÏõåÎìú: ', content)
          
          result = f"üéØ *Ïø†Ìå° ÌååÌä∏ÎÑàÏä§ Í≥†ÏàòÏàòÎ£å Ï†úÌíà*\nüìÖ {now}\n\n"
          
          for cat in categories[1:]:  # Ï≤´ Î≤àÏß∏Îäî Ìó§ÎçîÎùº Í±¥ÎÑàÎúÄ
              lines = cat.split('\n')
              keyword = lines[0].strip()
              
              result += f"üìÇ *{keyword}*\n\n"
              
              # TOP 3 Ï†úÌíà Ï∂îÏ∂ú
              products = re.findall(r'(\d+)\. (.+?)(?:üöÄ)?\n\s+üí∞ Í∞ÄÍ≤©: ([\d,]+)Ïõê\n\s+üìÇ Ïπ¥ÌÖåÍ≥†Î¶¨: (.+?)\n\s+üìä ÏòàÏÉÅ ÏàòÏàòÎ£åÏú®: ([\d.]+)% \(Ï∂îÏ†ïÏπò\)\n\s+üíµ ÏòàÏÉÅ ÏàòÏàòÎ£å: ([\d,]+)Ïõê\n\s+üîó (https?://[^\s]+)', cat, re.DOTALL)
              
              for i, prod in enumerate(products[:3], 1):
                  rank, name, price, category, rate, commission, url = prod
                  # Ï†úÌíàÎ™Ö Í∏∏Ïù¥ Ï†úÌïú
                  name_short = name[:40] + '...' if len(name) > 40 else name
                  result += f"*{i}. {name_short}*\n"
                  result += f"üí∞ {price}Ïõê | üìä {rate}% | üíµ {commission}Ïõê\n"
                  result += f"üîó `{url}`\n\n"
              
              if not products:
                  result += "   ‚ö†Ô∏è Ï†úÌíà ÏóÜÏùå\n\n"
          
          # Ï†ÑÏ≤¥ ÏöîÏïΩ
          total_match = re.search(r'Ï¥ù (\d+)Í∞ú ÏòàÏÉÅ Í≥†ÏàòÏàòÎ£å', content)
          best_rate_match = re.search(r'ÏòàÏÉÅ ÏàòÏàòÎ£åÏú®: ([\d.]+)%', content)
          best_commission_match = re.search(r'ÏòàÏÉÅ ÏàòÏàòÎ£å: ([\d,]+)Ïõê', content)
          
          result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
          if total_match:
              result += f"‚úÖ Ï¥ù {total_match.group(1)}Í∞ú Ï†úÌíà Î∞úÍ≤¨\n"
          if best_rate_match and best_commission_match:
              result += f"ü•á ÏµúÍ≥†: {best_rate_match.group(1)}% ({best_commission_match.group(1)}Ïõê)"
          
          print(result)
          PYTHON_SCRIPT
          
          python3 parse_result.py > telegram_message.txt
          
          # ÌÖîÎ†àÍ∑∏Îû® Ï†ÑÏÜ°
          MESSAGE=$(cat telegram_message.txt)
          
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"text\": $(echo "$MESSAGE" | jq -Rs .),
              \"parse_mode\": \"Markdown\"
            }"
