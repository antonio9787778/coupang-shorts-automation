name: ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ìë™í™”

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ KST

jobs:
  coupang-search:
    name: ì¿ íŒ¡ ê³ ìˆ˜ìˆ˜ë£Œ ì œí’ˆ ê²€ìƒ‰
    runs-on: ubuntu-latest
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pip install requests
      
      - name: ì¿ íŒ¡ API ì œí’ˆ ê²€ìƒ‰
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
        run: |
          echo "ğŸ” ì¿ íŒ¡ ì œí’ˆ ê²€ìƒ‰ ì‹œì‘..."
          python coupang_smart_finder.py > result.txt 2>&1
          STATUS=$?
          
          if [ $STATUS -eq 0 ]; then
            echo "âœ… ê²€ìƒ‰ ì™„ë£Œ (exit code: $STATUS)"
          else
            echo "âš ï¸ ê²€ìƒ‰ ì™„ë£Œ (exit code: $STATUS)"
          fi
          
          if [ -f result.txt ]; then
            FILESIZE=$(wc -c < result.txt)
            LINES=$(wc -l < result.txt)
            echo "ğŸ“„ result.txt: ${FILESIZE} bytes, ${LINES} ì¤„"
          else
            echo "âŒ result.txt íŒŒì¼ ì—†ìŒ"
            exit 1
          fi
      
      - name: ê²°ê³¼ íŒŒì¼ ì¶œë ¥
        if: always()
        run: |
          echo "============================================"
          echo "ğŸ“‹ result.txt ì „ì²´ ë‚´ìš©:"
          echo "============================================"
          cat result.txt || echo "íŒŒì¼ ì—†ìŒ"
          echo "============================================"
      
      - name: í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ìƒì„± ë° ì „ì†¡
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸ“± í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ìƒì„± ì¤‘..."
          
          python3 << 'EOF'
          import re
          import json
          import os
          from datetime import datetime
          import subprocess
          
          def create_telegram_message():
              """result.txtë¥¼ íŒŒì‹±í•˜ì—¬ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ìƒì„±"""
              try:
                  with open('result.txt', 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  if not content:
                      return "âš ï¸ result.txtê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."
                  
                  now = datetime.now().strftime('%Y-%m-%d %H:%M KST')
                  message = f"ğŸ¯ *ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ê³ ìˆ˜ìˆ˜ë£Œ ì œí’ˆ*\nğŸ“… {now}\n\n"
                  
                  # ì¹´í…Œê³ ë¦¬ë³„ ë¶„ë¦¬
                  categories = re.split(r'={70}\nğŸ“Œ í‚¤ì›Œë“œ: ', content)
                  
                  product_found = False
                  
                  for cat in categories[1:]:
                      lines = cat.split('\n')
                      keyword = lines[0].strip()
                      
                      message += f"ğŸ“‚ *{keyword}*\n\n"
                      
                      # ì œí’ˆ ì¶”ì¶œ íŒ¨í„´ (ì‹¤ì œ ë¡œê·¸ í˜•ì‹ì— ë§ì¶¤)
                      pattern = r'(\d+)\.\s+(.+?)(?:ğŸš€)?\s*\n\s+ğŸ’° ê°€ê²©:\s+([\d,]+)ì›\s*\n\s+ğŸ“‚ ì¹´í…Œê³ ë¦¬:\s+(.+?)\s*\n\s+ğŸ“Š ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨:\s+([\d.]+)%\s+\(ì¶”ì •ì¹˜\)\s*\n\s+ğŸ’µ ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ:\s+([\d,]+)ì›\s*\n\s+ğŸ”—\s+(.+?)(?:\.\.\.)?\s*\n'
                      
                      products = re.findall(pattern, cat, re.MULTILINE)
                      
                      if products:
                          product_found = True
                          # ë¡œì¼“ë°°ì†¡ ì²´í¬
                          rocket_nums = set(re.findall(r'(\d+)\.\s+.+?ğŸš€', cat))
                          
                          # TOP 3ë§Œ
                          for rank, name, price, category, rate, commission, url in products[:3]:
                              name = name.strip()
                              if len(name) > 35:
                                  name = name[:35] + '...'
                              
                              rocket = "ğŸš€ " if rank in rocket_nums else ""
                              
                              message += f"*{rank}. {rocket}{name}*\n"
                              message += f"ğŸ’° {price}ì› | ğŸ“Š {rate}%\n"
                              message += f"ğŸ’µ {commission}ì›\n\n"
                      else:
                          message += "   âš ï¸ ì œí’ˆ ì—†ìŒ\n\n"
                  
                  # ìš”ì•½ ì •ë³´
                  summary = re.search(r'ì´ (\d+)ê°œ ì˜ˆìƒ ê³ ìˆ˜ìˆ˜ë£Œ', content)
                  best = re.search(r'ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨:\s+([\d.]+)%\s+ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ:\s+([\d,]+)ì›', content)
                  
                  message += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
                  
                  if summary:
                      message += f"âœ… ì´ {summary.group(1)}ê°œ ì œí’ˆ ë°œê²¬\n"
                  
                  if best:
                      message += f"ğŸ¥‡ ìµœê³ : {best.group(1)}% ({best.group(2)}ì›)"
                  
                  if not product_found:
                      message += "\nâš ï¸ ê²€ìƒ‰ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤"
                  
                  return message
              
              except FileNotFoundError:
                  return "âŒ result.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              except Exception as e:
                  return f"âš ï¸ ë©”ì‹œì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n{str(e)}"
          
          def send_telegram(message):
              """í…”ë ˆê·¸ë¨ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡"""
              bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
              chat_id = os.environ.get('TELEGRAM_CHAT_ID')
              
              if not bot_token or not chat_id:
                  print("âŒ í…”ë ˆê·¸ë¨ í™˜ê²½ ë³€ìˆ˜ ì—†ìŒ")
                  return False
              
              url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
              
              payload = {
                  "chat_id": chat_id,
                  "text": message,
                  "parse_mode": "Markdown"
              }
              
              try:
                  import requests
                  response = requests.post(url, json=payload, timeout=10)
                  
                  if response.status_code == 200:
                      result = response.json()
                      if result.get('ok'):
                          print("âœ… í…”ë ˆê·¸ë¨ ì „ì†¡ ì„±ê³µ!")
                          return True
                      else:
                          print(f"âš ï¸ í…”ë ˆê·¸ë¨ API ì˜¤ë¥˜: {result}")
                          return False
                  else:
                      print(f"âŒ HTTP ì˜¤ë¥˜: {response.status_code}")
                      print(response.text)
                      return False
              
              except Exception as e:
                  print(f"âŒ ì „ì†¡ ì‹¤íŒ¨: {e}")
                  return False
          
          # ì‹¤í–‰
          print("ë©”ì‹œì§€ ìƒì„± ì¤‘...")
          message = create_telegram_message()
          
          print("\nìƒì„±ëœ ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°:")
          print("=" * 50)
          print(message[:500])
          if len(message) > 500:
              print("... (ìƒëµ)")
          print("=" * 50)
          print()
          
          print("í…”ë ˆê·¸ë¨ ì „ì†¡ ì¤‘...")
          success = send_telegram(message)
          
          if not success:
              print("\nâš ï¸ í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨í–ˆì§€ë§Œ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.")
          
          EOF
          
          echo ""
          echo "âœ… ì›Œí¬í”Œë¡œìš° ì™„ë£Œ!"
