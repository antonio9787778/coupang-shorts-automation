name: ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ìë™í™”

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  test-dummy:
    name: 1ë‹¨ê³„ - ë”ë¯¸ ë°ì´í„° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: ë”ë¯¸ í…ŒìŠ¤íŠ¸
        run: python test_coupang_logic.py

  coupang-api:
    name: 2ë‹¨ê³„ - ì¿ íŒ¡ API ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: test-dummy
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: requests ì„¤ì¹˜
        run: pip install requests
      
      - name: ì¿ íŒ¡ ì œí’ˆ ì°¾ê¸°
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
        run: |
          echo "ğŸš€ ì¿ íŒ¡ API í˜¸ì¶œ ì‹œì‘..."
          python coupang_smart_finder.py 2>&1 | tee result.txt
          echo ""
          echo "âœ… ì‹¤í–‰ ì™„ë£Œ! result.txtì— ì €ì¥ë¨"
      
      - name: result.txt ë‚´ìš© í™•ì¸
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“‹ result.txt ì „ì²´ ë‚´ìš©:"
          echo "========================================"
          cat result.txt || echo "âŒ result.txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
      
      - name: ê²°ê³¼ ì •ë¦¬ ë° í…”ë ˆê·¸ë¨ ì „ì†¡
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          cat << 'PYTHON_SCRIPT' > parse_result.py
          import re
          import sys
          from datetime import datetime
          
          try:
              with open('result.txt', 'r', encoding='utf-8') as f:
                  content = f.read()
          except:
              print("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨")
              sys.exit(1)
          
          # í˜„ì¬ ì‹œê°„
          now = datetime.now().strftime('%Y-%m-%d %H:%M KST')
          
          # ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë¶„ë¦¬
          categories = re.split(r'={70}\nğŸ“Œ í‚¤ì›Œë“œ: ', content)
          
          result = f"ğŸ¯ *ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ê³ ìˆ˜ìˆ˜ë£Œ ì œí’ˆ*\nğŸ“… {now}\n\n"
          
          for cat in categories[1:]:  # ì²« ë²ˆì§¸ëŠ” í—¤ë”ë¼ ê±´ë„ˆëœ€
              lines = cat.split('\n')
              keyword = lines[0].strip()
              
              result += f"ğŸ“‚ *{keyword}*\n\n"
              
              # TOP 3 ì œí’ˆ ì¶”ì¶œ (ìš°ì„ ìˆœìœ„ ì ìˆ˜ í¬í•¨)
              products = re.findall(
                  r'(\d+)\. (.+?)\n'
                  r'(?:\s+ğŸš€ ë¡œì¼“ë°°ì†¡\n)?'
                  r'\s+ğŸ’° ê°€ê²©: ([\d,]+)ì›\n'
                  r'\s+ğŸ“‚ ì¹´í…Œê³ ë¦¬: (.+?)\n'
                  r'\s+ğŸ“Š ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨: ([\d.]+)% \(ì¶”ì •ì¹˜\)\n'
                  r'\s+ğŸ’µ ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ: ([\d,]+)ì›\n'
                  r'\s+â­ ìš°ì„ ìˆœìœ„ ì ìˆ˜: ([\d.]+)\n'
                  r'\s+ğŸ”— (https?://[^\s]+)',
                  cat, re.DOTALL
              )
              
              # ë¡œì¼“ë°°ì†¡ ì²´í¬ (ë³„ë„ë¡œ í™•ì¸)
              rocket_products = re.findall(r'(\d+)\. .+?\n\s+ğŸš€ ë¡œì¼“ë°°ì†¡', cat)
              rocket_set = set(rocket_products)
              
              for i, prod in enumerate(products[:3], 1):
                  rank, name, price, category, rate, commission, priority, url = prod
                  
                  # ì œí’ˆëª… ê¸¸ì´ ì œí•œ
                  name_short = name[:40] + '...' if len(name) > 40 else name
                  
                  # ë¡œì¼“ë°°ì†¡ í‘œì‹œ
                  rocket_icon = "ğŸš€ " if rank in rocket_set else ""
                  
                  result += f"*{i}. {rocket_icon}{name_short}*\n"
                  result += f"ğŸ’° {price}ì› | ğŸ“Š {rate}% | ğŸ’µ {commission}ì›\n"
                  result += f"â­ ìš°ì„ ìˆœìœ„: {priority}ì \n"
                  result += f"ğŸ”— `{url}`\n\n"
              
              if not products:
                  result += "   âš ï¸ ì œí’ˆ ì—†ìŒ\n\n"
          
          # ì „ì²´ ìš”ì•½ ì¶”ì¶œ
          summary_match = re.search(
              r'ì´ (\d+)ê°œ ì˜ˆìƒ ê³ ìˆ˜ìˆ˜ë£Œ.+?'
              r'ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨: ([\d.]+)%\n.+?'
              r'ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ: ([\d,]+)ì›\n.+?'
              r'ë¡œì¼“ë°°ì†¡: ([OX])\n.+?'
              r'ìš°ì„ ìˆœìœ„ ì ìˆ˜: ([\d.]+)',
              content, re.DOTALL
          )
          
          # ë¡œì¼“ë°°ì†¡ ë¹„ìœ¨ ì¶”ì¶œ
          rocket_ratio_match = re.search(r'ë¡œì¼“ë°°ì†¡ ë¹„ìœ¨: ([\d.]+)%', content)
          
          result += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
          if summary_match:
              total, best_rate, best_commission, is_rocket, priority = summary_match.groups()
              result += f"âœ… ì´ {total}ê°œ ì œí’ˆ ë°œê²¬\n"
              result += f"ğŸ¥‡ ìµœê³ : {best_rate}% ({best_commission}ì›)\n"
              result += f"â­ ìš°ì„ ìˆœìœ„: {priority}ì  | ğŸš€ {is_rocket}\n"
              if rocket_ratio_match:
                  result += f"ğŸš€ ë¡œì¼“ë°°ì†¡ ë¹„ìœ¨: {rocket_ratio_match.group(1)}%"
          
          print(result)
          PYTHON_SCRIPT
          
          python3 parse_result.py > telegram_message.txt
          
          # í…”ë ˆê·¸ë¨ ì „ì†¡
          MESSAGE=$(cat telegram_message.txt)
          
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"text\": $(echo "$MESSAGE" | jq -Rs .),
              \"parse_mode\": \"Markdown\"
            }"
          
          echo ""
          echo "âœ… í…”ë ˆê·¸ë¨ ì „ì†¡ ì™„ë£Œ!"
