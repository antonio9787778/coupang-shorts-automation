name: ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ìë™í™”

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  test-dummy:
    name: 1ë‹¨ê³„ - ë”ë¯¸ ë°ì´í„° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: ë”ë¯¸ í…ŒìŠ¤íŠ¸
        run: python test_coupang_logic.py

  coupang-api:
    name: 2ë‹¨ê³„ - ì¿ íŒ¡ API ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: test-dummy
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: requests ì„¤ì¹˜
        run: pip install requests
      
      - name: ì¿ íŒ¡ ì œí’ˆ ì°¾ê¸°
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
        run: python coupang_smart_finder.py | tee result.txt
      
      - name: ê²°ê³¼ íŒŒì¼ ì €ì¥
        run: |
          if [ -f result.txt ]; then
            echo "ê²°ê³¼ íŒŒì¼ ìƒì„± ì™„ë£Œ"
            cat result.txt
          fi
      
      - name: í…”ë ˆê·¸ë¨ ì•Œë¦¼
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M KST')
          
          if [ "$STATUS" = "success" ]; then
            EMOJI="âœ…"
            TITLE="ì„±ê³µ"
          else
            EMOJI="âŒ"
            TITLE="ì‹¤íŒ¨"
          fi
          
          if [ -f result.txt ]; then
            TOTAL=$(grep -oP 'ì´ \K\d+' result.txt 2>/dev/null || echo "0")
            RATE=$(grep -oP 'ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨: \K[\d.]+' result.txt 2>/dev/null | head -1 || echo "N/A")
          else
            TOTAL="0"
            RATE="N/A"
          fi
          
          TEXT="${EMOJI} ì¿ íŒ¡ ìë™í™” ${TITLE}%0A%0AğŸ“… ${TIME}%0AğŸ“Š ì´ ${TOTAL}ê°œ ì œí’ˆ%0AğŸ¥‡ ìµœê³  ìˆ˜ìˆ˜ë£Œìœ¨: ${RATE}%%0A%0AğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${TEXT}"
