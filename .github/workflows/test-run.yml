name: ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ìë™í™”

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  test-dummy:
    name: 1ë‹¨ê³„ - ê¸°ë³¸ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: ë”ë¯¸ í…ŒìŠ¤íŠ¸
        run: python test_coupang_logic.py

  coupang-api:
    name: 2ë‹¨ê³„ - ì¿ íŒ¡ API ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: test-dummy
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: requests ì„¤ì¹˜
        run: pip install requests
      
      - name: ì¿ íŒ¡ ì œí’ˆ ì°¾ê¸°
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
        run: |
          python coupang_smart_finder.py | tee result.txt
          echo "âœ… ì¿ íŒ¡ ì œí’ˆ ê²€ìƒ‰ ì™„ë£Œ"
      
      - name: ê²°ê³¼ íŒŒì¼ í™•ì¸
        if: always()
        run: |
          if [ -f result.txt ]; then
            echo "ê²°ê³¼ íŒŒì¼ ìƒì„± ì™„ë£Œ"
            cat result.txt
          else
            echo "ê²°ê³¼ íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi
      
      - name: í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ìƒì„±
        if: always()
        run: |
          cat << 'PYEND' > telegram_sender.py
          import re
          from datetime import datetime
          import sys
          
          try:
              with open('result.txt', 'r', encoding='utf-8') as f:
                  content = f.read()
              
              print(f"íŒŒì¼ ì½ê¸° ì„±ê³µ ({len(content)} ì)")
              
              now = datetime.now().strftime('%Y-%m-%d %H:%M KST')
              message = f"ğŸ¯ *ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ê³ ìˆ˜ìˆ˜ë£Œ ì œí’ˆ*\nğŸ“… {now}\n\n"
              
              categories = re.split(r'={70}\nğŸ“Œ í‚¤ì›Œë“œ: ', content)
              print(f"ì¹´í…Œê³ ë¦¬ ê°œìˆ˜: {len(categories)}")
              
              for cat in categories[1:]:
                  lines = cat.split('\n')
                  keyword = lines[0].strip()
                  message += f"ğŸ“‚ *{keyword}*\n\n"
                  
                  pattern = r'(\d+)\.\s+(.+?)(?:ğŸš€)?\s*\n\s+ğŸ’° ê°€ê²©:\s+([\d,]+)ì›\s*\n\s+ğŸ“‚ ì¹´í…Œê³ ë¦¬:\s+(.+?)\s*\n\s+ğŸ“Š ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨:\s+([\d.]+)%\s+\(ì¶”ì •ì¹˜\)\s*\n\s+ğŸ’µ ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ:\s+([\d,]+)ì›\s*\n\s+ğŸ”—\s+\[?(https?://[^\s\]]+)'
                  products = re.findall(pattern, cat)
                  
                  print(f"  {keyword}: {len(products)}ê°œ ì œí’ˆ")
                  
                  if products:
                      rocket_set = set(re.findall(r'(\d+)\.\s+.+?ğŸš€', cat))
                      
                      for prod in products[:3]:
                          rank, name, price, category, rate, commission, url = prod
                          name_clean = name.strip()
                          if len(name_clean) > 40:
                              name_clean = name_clean[:40] + '...'
                          
                          rocket_icon = "ğŸš€ " if rank in rocket_set else ""
                          
                          message += f"*{rank}. {rocket_icon}{name_clean}*\n"
                          message += f"ğŸ’° {price}ì› | ğŸ“Š {rate}%\n"
                          message += f"ğŸ’µ {commission}ì›\n"
                          message += f"ğŸ”— {url[:70]}...\n\n"
                  else:
                      message += "   âš ï¸ ì œí’ˆ ì—†ìŒ\n\n"
              
              summary_match = re.search(r'ì´ (\d+)ê°œ ì˜ˆìƒ ê³ ìˆ˜ìˆ˜ë£Œ', content)
              best_match = re.search(r'ìµœê³  ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨ ì œí’ˆ:\s+(.+?)\s+ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œìœ¨:\s+([\d.]+)%\s+ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ:\s+([\d,]+)ì›', content, re.DOTALL)
              
              message += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
              
              if summary_match:
                  message += f"âœ… ì´ {summary_match.group(1)}ê°œ ì œí’ˆ ë°œê²¬\n"
              
              if best_match:
                  rate = best_match.group(2)
                  commission = best_match.group(3)
                  message += f"ğŸ¥‡ ìµœê³ : {rate}% ({commission}ì›)"
              
              print("\nìƒì„±ëœ ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°:")
              print(message[:500])
              
              with open('telegram_message.txt', 'w', encoding='utf-8') as f:
                  f.write(message)
              
              print("\nâœ… telegram_message.txt ì €ì¥ ì™„ë£Œ")
              
          except Exception as e:
              print(f"âŒ ì˜¤ë¥˜: {e}")
              import traceback
              traceback.print_exc()
              
              error_msg = f"âš ï¸ ì¿ íŒ¡ ê²€ìƒ‰ ì™„ë£Œ\n\níŒŒì‹± ì˜¤ë¥˜: {str(e)}"
              with open('telegram_message.txt', 'w', encoding='utf-8') as f:
                  f.write(error_msg)
          PYEND
          
          python3 telegram_sender.py
      
      - name: í…”ë ˆê·¸ë¨ ì „ì†¡
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -f telegram_message.txt ]; then
            echo "âŒ telegram_message.txt ì—†ìŒ"
            exit 1
          fi
          
          echo "ğŸ“¤ í…”ë ˆê·¸ë¨ ì „ì†¡ ì¤‘..."
          
          MESSAGE=$(cat telegram_message.txt | python3 -c "import json, sys; print(json.dumps(sys.stdin.read()))")
          
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${TELEGRAM_CHAT_ID}\",\"text\":${MESSAGE},\"parse_mode\":\"Markdown\"}")
          
          echo "ì‘ë‹µ:"
          echo "$RESPONSE"
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… ì „ì†¡ ì„±ê³µ!"
          else
            echo "âš ï¸ ì „ì†¡ ì‹¤íŒ¨"
          fi
