name: ğŸš€ ì¿ íŒ¡ â†’ ì‡¼ì¸  ì „ì²´ íŒŒì´í”„ë¼ì¸ 

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ KST

jobs:
  # Job 1: ì¿ íŒ¡ ì œí’ˆ ê²€ìƒ‰
  search-products:
    name: 1ï¸âƒ£ ì¿ íŒ¡ ì œí’ˆ ê²€ìƒ‰
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pip install requests
      
      - name: ğŸ” ì¿ íŒ¡ API ì œí’ˆ ê²€ìƒ‰
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
        run: |
          echo "ğŸ” ì¿ íŒ¡ ì œí’ˆ ê²€ìƒ‰ ì‹œì‘..."
          echo ""
          
          # â­ coupang_smart_finder.py ì‹¤í–‰
          python -u coupang_smart_finder.py 2>&1 | tee result.txt
          
          EXIT_CODE=${PIPESTATUS[0]}
          echo ""
          echo "Python ì¢…ë£Œ ì½”ë“œ: $EXIT_CODE"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤íŒ¨ (exit code: $EXIT_CODE)"
            echo ""
            echo "ğŸ“‹ result.txt ë‚´ìš©:"
            cat result.txt
            exit $EXIT_CODE
          fi
          
          echo ""
          echo "âœ… ê²€ìƒ‰ ì™„ë£Œ"
      
      - name: result.txt ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: search-result
          path: result.txt
          retention-days: 1
  
  # Job 2: ì‡¼ì¸  ìƒì„±
  create-shorts:
    name: 2ï¸âƒ£ ì‡¼ì¸  ìƒì„±
    needs: search-products
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-nanum fonts-nanum-coding
      
      - name: Python ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install moviepy==1.0.3
          pip install gtts pillow requests imageio-ffmpeg
      
      - name: result.txt ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: search-result
      
      - name: result.txt í™•ì¸
        run: |
          echo "ğŸ“‹ result.txt ë‚´ìš© í™•ì¸:"
          if [ -f result.txt ]; then
            cat result.txt
          else
            echo "âŒ result.txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
      
      - name: ì‡¼ì¸  ìƒì„±
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
        run: |
          echo "ğŸ¬ ì‡¼ì¸  ìƒì„± ì‹œì‘..."
          python pipeline_manager.py
  
  # Job 3: í…”ë ˆê·¸ë¨ ì•Œë¦¼
  notify:
    name: 3ï¸âƒ£ í…”ë ˆê·¸ë¨ ì•Œë¦¼
    needs: create-shorts
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: coupang-shorts-${{ github.run_number }}
        continue-on-error: true
      
      - name: í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì „ì†¡
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -f summary.txt ]; then
            SUMMARY=$(cat summary.txt)
            STATUS="âœ… ì‡¼ì¸  ìƒì„± ì™„ë£Œ!"
          else
            SUMMARY="ì‡¼ì¸  ìƒì„± ì‹¤íŒ¨"
            STATUS="âŒ ì˜¤ë¥˜ ë°œìƒ"
          fi
          
          MESSAGE=$(cat <<EOF
          ğŸš€ ì¿ íŒ¡ ì‡¼ì¸  ìë™ ìƒì„± ì™„ë£Œ
          
          ${STATUS}
          ${SUMMARY}
          
          ğŸ“¥ ë‹¤ìš´ë¡œë“œ: GitHub Actions â†’ Artifacts
          ğŸ”— íŒŒíŠ¸ë„ˆìŠ¤ ë§í¬ í¬í•¨ë¨!
          EOF
          )
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}"
